<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Landlord Dashboard - Virgil Rental Connect</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background-color: rgba(0,0,0,0.6);
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      background: rgba(255,255,255,0.95);
      color: black;
      max-width: 1000px;
      margin: 80px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    h2 { text-align: center; margin-bottom: 20px; }
    table { margin-top: 15px; }
    label { font-weight: 600; }
    .navbar {
      position: relative;
      z-index: 2;
      background-color: #343a40 !important;
    }
    .navbar .nav-link { color: #fff !important; }
    .navbar .nav-item.active .nav-link { font-weight: bold; text-decoration: underline; }
    .navbar .navbar-brand { color: #fff !important; }
    .navbar-collapse { background-color: #343a40; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">Virgil Rental Connect</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active"><a class="nav-link" href="landlord-dashboard.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2>Landlord Dashboard</h2>

    <!-- Add Property Form -->
    <form id="propertyForm" class="mb-5">
      <label for="name">Property Name:</label>
      <input type="text" id="name" class="form-control" required />

      <label for="description">Description:</label>
      <textarea id="description" class="form-control" rows="3"></textarea>

      <label for="price">Price per Month (KES):</label>
      <input type="number" id="price" class="form-control" required />

      <label for="image">Image URL:</label>
      <input type="url" id="image" class="form-control" />

      <button type="submit" class="btn btn-primary mt-3">Add Property</button>
    </form>

    <h3>My Properties & Bookings</h3>
    <div id="propertiesContainer"></div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = 'http://127.0.0.1:8000/api';
    const token = localStorage.getItem("token");
    const userRole = localStorage.getItem("userRole"); 

    console.log("Token being sent:", token);

    // Redirect if not logged in or not a landlord
    if (!token) {
        alert("You need to login first.");
        window.location.href = "login.html";
    } else {
        let decodedRole = userRole;
        try {
            const decoded = jwt_decode(token);
            decodedRole = decoded?.role || userRole;
        } catch {
            decodedRole = userRole;
        }
        if (decodedRole !== 'landlord') {
            alert("Access denied! Landlords only.");
            window.location.href = "login.html";
        }
    }

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
    });

    // Add property
    document.getElementById('propertyForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
            name: document.getElementById('name').value.trim(),
            description: document.getElementById('description').value,
            price_per_month: document.getElementById('price').value,
            image_url: document.getElementById('image').value
        };
        try {
            const res = await fetch(`${API_BASE}/landlord/properties/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed to add property');
            alert('Property added! Waiting for admin approval.');
            e.target.reset();
            fetchLandlordProperties();
        } catch (err) {
            console.error(err);
            alert(err.message || 'Error adding property');
        }
    });

    async function fetchLandlordProperties() {
        try {
            const res = await fetch(`${API_BASE}/landlord/properties/`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Failed to fetch properties");
            const properties = await res.json();

            const container = document.getElementById('propertiesContainer');
            container.innerHTML = '';
            if (properties.length === 0) {
                container.innerHTML = '<p>No properties found. Add some first.</p>';
                return;
            }

            for (let prop of properties) {
                const propDiv = document.createElement('div');
                propDiv.classList.add('mb-4');
                propDiv.innerHTML = `
                    <h4>${prop.name} - Ksh${prop.price_per_month}/month ${prop.approved ? '(Approved)' : '(Pending Approval)'}</h4>
                    <p>${prop.description}</p>
                    <strong>Bookings:</strong>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Tenant Email</th>
                                <th>Booking Date</th>
                                <th>Status</th>
                                <th>Payment</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-${prop.id}"><tr><td colspan="4">Loading...</td></tr></tbody>
                    </table>
                `;
                container.appendChild(propDiv);

                // Fetch bookings
                const bookingsRes = await fetch(`${API_BASE}/bookings/`);
                const bookings = await bookingsRes.json();
                const filteredBookings = bookings.filter(b => b.property === prop.id);
                const tbody = document.getElementById(`bookings-${prop.id}`);
                tbody.innerHTML = '';

                if (filteredBookings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No bookings yet.</td></tr>';
                } else {
                    const paymentsRes = await fetch(`${API_BASE}/payments/`);
                    const payments = await paymentsRes.json();

                    for (let b of filteredBookings) {
                        const bookingPayments = payments.filter(p => p.booking === b.id);
                        tbody.innerHTML += `
                            <tr>
                                <td>${b.email}</td>
                                <td>${b.booking_date}</td>
                                <td>${b.status}</td>
                                <td>${bookingPayments.length ? bookingPayments.map(p => 'Ksh'+p.amount).join(', ') : '-'}</td>
                            </tr>
                        `;
                    }
                }
            }

        } catch (err) {
            console.error(err);
            document.getElementById('propertiesContainer').innerHTML = '<p>Error loading properties.</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', fetchLandlordProperties);
  </script>
</body>
</html>