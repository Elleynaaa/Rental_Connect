<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book Your Property - Virgil Rental Connect</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
      color: white;
      position: relative;
      min-height: 100vh;
      margin: 0;
    }
    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.95);
      color: black;
      max-width: 600px;
      margin: 80px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      font-weight: 600;
    }
    #error {
      min-height: 1.5em;
      margin-top: 15px;
      color: #d9534f;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">Virgil Rental Connect</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="aboutus.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          <li class="nav-item active"><a class="nav-link" href="booking.html">Booking</a></li>
          <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2>Book Your Property</h2>
    <form id="bookingForm">
      <label for="email">Email:</label>
      <input type="email" id="email" required placeholder="Your email" class="form-control" />

      <label for="timeSlot">Time Slot:</label>
      <select id="timeSlot" required class="form-control">
        <option value="" disabled selected>Select a time slot</option>
        <option value="Morning">Morning</option>
        <option value="Afternoon">Afternoon</option>
        <option value="Evening">Evening</option>
      </select>

      <label for="roomType">Room Type:</label>
      <select id="roomType" required class="form-control">
        <option value="" disabled selected>Select room type</option>
        <option value="Single">Single</option>
        <option value="Double">Double</option>
        <option value="Suite">Suite</option>
      </select>

      <label for="propertySelect">Select Property:</label>
      <select id="propertySelect" required class="form-control">
        <option value="" disabled selected>Loading properties...</option>
      </select>

      <label for="bookingDate">Booking Date:</label>
      <input type="date" id="bookingDate" required class="form-control" />

      <div id="error"></div>

      <button type="submit" class="btn btn-primary btn-block mt-3">Submit Booking</button>
    </form>
  </div>

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = 'http://127.0.0.1:8000/api';
    const NODE_BASE = 'http://localhost:3000';

    async function fetchProperties() {
      try {
        const res = await fetch(`${API_BASE}/properties/`);
        if (!res.ok) throw new Error('Failed to load properties');
        const properties = await res.json();

        const propertySelect = document.getElementById('propertySelect');
        propertySelect.innerHTML = '<option value="" disabled selected>Select a property</option>';

        properties.forEach(property => {
          propertySelect.innerHTML += `<option value="${property.id}">${property.name} - $${property.price_per_month}/month</option>`;
        });
      } catch (error) {
        console.error(error);
        const propertySelect = document.getElementById('propertySelect');
        propertySelect.innerHTML = '<option value="" disabled>Error loading properties</option>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchProperties();

      document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('error').textContent = '';

        const email = document.getElementById('email').value.trim();
        const timeSlot = document.getElementById('timeSlot').value;
        const roomType = document.getElementById('roomType').value;
        const propertyId = document.getElementById('propertySelect').value;
        const bookingDate = document.getElementById('bookingDate').value;

        if (!email || !timeSlot || !roomType || !propertyId || !bookingDate) {
          document.getElementById('error').textContent = 'Please fill in all fields.';
          return;
        }

        try {
          // Search tenant by email
          const tenantRes = await fetch(`${API_BASE}/tenants/?search=${encodeURIComponent(email)}`);
          if (!tenantRes.ok) throw new Error('Failed to search tenant');
          const tenants = await tenantRes.json();

          if (tenants.length === 0) {
            throw new Error('Tenant not found. Please register first.');
          }

          const tenant = tenants[0];

          // Prepare booking payload
          const bookingPayload = {
            property: propertyId,
            email,
            booking_date: bookingDate,
            time_slot: timeSlot,
            room_type: roomType,
            tenant: tenant.id
          };

          const bookingRes = await fetch(`${API_BASE}/bookings/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookingPayload)
          });

          if (!bookingRes.ok) {
            const errData = await bookingRes.json();
            throw new Error(errData.detail || JSON.stringify(errData));
          }

          const bookingData = await bookingRes.json();

          // Save booking info for payment page
          localStorage.setItem('bookingInfo', JSON.stringify(bookingData));

          // Send confirmation email via Node server
          await fetch(`${NODE_BASE}/sendConfirmationEmail`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              roomType,
              timeSlot
            })
          });

          alert('Booking successful! Confirmation email sent. Redirecting to payment page...');
          window.location.href = 'payment.html';

        } catch (err) {
          console.error(err);
          document.getElementById('error').textContent = err.message || 'Booking failed. Try again.';
        }
      });
    });
  </script>
</body>
</html>